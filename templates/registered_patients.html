{% extends "base.html" %}

{% block title %}Registered Patients - Privacy Umbrella Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-people-fill"></i> Registered Patients</h2>
            <p class="text-muted">Manage privacy settings and remote anonymization for registered patients</p>
        </div>
    </div>

    <!-- MQTT Connection Status -->
    <div class="row mb-3">
        <div class="col">
            <div class="alert alert-info" role="alert">
                <i class="bi bi-info-circle"></i>
                <strong>MQTT Status:</strong> <span id="mqtt-status">Checking...</span>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" id="search-input" placeholder="Search by unique key or device ID...">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="filter-remote-anon">
                <option value="">All Patients</option>
                <option value="enabled">Remote Anon Enabled</option>
                <option value="disabled">Remote Anon Disabled</option>
            </select>
        </div>
        <div class="col-md-3 text-end">
            <button class="btn btn-primary" onclick="loadPatients()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Patients Table -->
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Registered Patients List</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Unique Key</th>
                                    <th>Device ID</th>
                                    <th>Last Session</th>
                                    <th>K-Value</th>
                                    <th>Time Window</th>
                                    <th>Auto Anon</th>
                                    <th>Remote Anon</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="patients-table-body">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Settings Modal -->
<div class="modal fade" id="updateSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-gear"></i> Update Privacy Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Patient Info -->
                <div class="alert alert-secondary">
                    <h6>Patient Information</h6>
                    <p class="mb-1"><strong>Unique Key:</strong> <span id="modal-unique-key">N/A</span></p>
                    <p class="mb-1"><strong>Device ID:</strong> <span id="modal-device-id">N/A</span></p>
                    <p class="mb-0"><strong>Last Session:</strong> <span id="modal-last-session">N/A</span></p>
                </div>

                <!-- Current Settings -->
                <h6>Current Settings</h6>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <small class="text-muted">K-Value</small>
                                <h4 id="current-k-value">-</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <small class="text-muted">Time Window</small>
                                <h4 id="current-time-window">-</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <small class="text-muted">Auto Anonymize</small>
                                <h4 id="current-auto-anon">-</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <!-- New Settings Form -->
                <h6>New Settings</h6>
                <form id="new-settings-form">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="new-k-value" class="form-label">K-Value</label>
                            <select class="form-select" id="new-k-value" required>
                                <option value="5">5</option>
                                <option value="10">10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                                <option value="30">30</option>
                            </select>
                            <small class="text-muted">Minimum group size for anonymization</small>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="new-time-window" class="form-label">Time Window (seconds)</label>
                            <input type="number" class="form-control" id="new-time-window"
                                   min="5" max="300" step="5" value="30" required>
                            <small class="text-muted">Data batching interval</small>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="new-auto-anon" class="form-label">Auto Anonymize</label>
                            <select class="form-select" id="new-auto-anon" required>
                                <option value="true">Enabled</option>
                                <option value="false">Disabled</option>
                            </select>
                            <small class="text-muted">Automatic anonymization</small>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Note:</strong> Settings will be sent to the patient's device via MQTT.
                        The device must be online to receive the update.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applySettings()">
                    <i class="bi bi-send"></i> Send Settings to Device
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentPatientUniqueKey = null;
let patients = [];

// Load patients on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPatients();
    checkMQTTStatus();

    // Set up search
    document.getElementById('search-input').addEventListener('input', filterPatients);
    document.getElementById('filter-remote-anon').addEventListener('change', filterPatients);
});

// Check MQTT connection status
async function checkMQTTStatus() {
    try {
        const response = await fetch('/api/mqtt/status');
        const data = await response.json();

        const statusElement = document.getElementById('mqtt-status');
        if (data.success && data.status.connected) {
            statusElement.innerHTML = '<span class="badge bg-success">Connected</span> to ' + data.status.broker_host;
        } else {
            statusElement.innerHTML = '<span class="badge bg-danger">Disconnected</span> - MQTT features unavailable';
        }
    } catch (error) {
        console.error('Error checking MQTT status:', error);
        document.getElementById('mqtt-status').innerHTML = '<span class="badge bg-danger">Error</span>';
    }
}

// Load all patients
async function loadPatients() {
    try {
        const response = await fetch('/api/patients/list');
        const data = await response.json();

        if (data.success) {
            patients = data.patients;
            displayPatients(patients);
        } else {
            showError('Failed to load patients: ' + data.error);
        }
    } catch (error) {
        console.error('Error loading patients:', error);
        showError('Error loading patients: ' + error.message);
    }
}

// Display patients in table
function displayPatients(patientList) {
    const tbody = document.getElementById('patients-table-body');
    tbody.innerHTML = '';

    if (patientList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No patients found</td></tr>';
        return;
    }

    patientList.forEach(patient => {
        const row = createPatientRow(patient);
        tbody.appendChild(row);
    });
}

// Create table row for patient
function createPatientRow(patient) {
    const row = document.createElement('tr');

    // Format last session
    const lastSession = patient.last_session ? new Date(patient.last_session).toLocaleString() : 'Never';

    // Remote anon status badge
    const remoteAnonBadge = patient.remote_anon_enabled
        ? '<span class="badge bg-success">Enabled</span>'
        : '<span class="badge bg-secondary">Disabled</span>';

    // Auto anon icon
    const autoAnonIcon = patient.auto_anonymize
        ? '<i class="bi bi-check-circle-fill text-success"></i>'
        : '<i class="bi bi-x-circle-fill text-secondary"></i>';

    row.innerHTML = `
        <td>
            <code class="small">${patient.unique_key_short}</code>
            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyToClipboard('${patient.unique_key}')" title="Copy full key">
                <i class="bi bi-clipboard"></i>
            </button>
        </td>
        <td>${patient.device_id}</td>
        <td><small>${lastSession}</small></td>
        <td><span class="badge bg-primary">${patient.k_value}</span></td>
        <td>${patient.time_window}s</td>
        <td class="text-center">${autoAnonIcon}</td>
        <td>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox"
                       id="remote-anon-${patient.id}"
                       ${patient.remote_anon_enabled ? 'checked' : ''}
                       onchange="toggleRemoteAnon('${patient.unique_key}', this.checked)">
                <label class="form-check-label" for="remote-anon-${patient.id}">
                    ${remoteAnonBadge}
                </label>
            </div>
        </td>
        <td>
            <button class="btn btn-sm btn-primary" onclick="openSettingsModal('${patient.unique_key}')">
                <i class="bi bi-gear"></i> Update
            </button>
        </td>
    `;

    return row;
}

// Filter patients based on search and filter
function filterPatients() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const filterValue = document.getElementById('filter-remote-anon').value;

    let filtered = patients;

    // Apply search filter
    if (searchTerm) {
        filtered = filtered.filter(p =>
            p.unique_key.toLowerCase().includes(searchTerm) ||
            p.device_id.toLowerCase().includes(searchTerm)
        );
    }

    // Apply remote anon filter
    if (filterValue === 'enabled') {
        filtered = filtered.filter(p => p.remote_anon_enabled);
    } else if (filterValue === 'disabled') {
        filtered = filtered.filter(p => !p.remote_anon_enabled);
    }

    displayPatients(filtered);
}

// Open settings modal for patient
function openSettingsModal(uniqueKey) {
    const patient = patients.find(p => p.unique_key === uniqueKey);
    if (!patient) return;

    currentPatientUniqueKey = uniqueKey;

    // Populate patient info
    document.getElementById('modal-unique-key').textContent = patient.unique_key_short;
    document.getElementById('modal-device-id').textContent = patient.device_id;
    document.getElementById('modal-last-session').textContent =
        patient.last_session ? new Date(patient.last_session).toLocaleString() : 'Never';

    // Populate current settings
    document.getElementById('current-k-value').textContent = patient.k_value;
    document.getElementById('current-time-window').textContent = patient.time_window + 's';
    document.getElementById('current-auto-anon').textContent = patient.auto_anonymize ? 'Enabled' : 'Disabled';

    // Set new settings form values to current
    document.getElementById('new-k-value').value = patient.k_value;
    document.getElementById('new-time-window').value = patient.time_window;
    document.getElementById('new-auto-anon').value = patient.auto_anonymize.toString();

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('updateSettingsModal'));
    modal.show();
}

// Apply new settings
async function applySettings() {
    if (!currentPatientUniqueKey) return;

    const settings = {
        k_value: parseInt(document.getElementById('new-k-value').value),
        time_window: parseInt(document.getElementById('new-time-window').value),
        auto_anonymize: document.getElementById('new-auto-anon').value === 'true'
    };

    try {
        const response = await fetch(`/api/patients/${currentPatientUniqueKey}/update-settings`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(settings)
        });

        const data = await response.json();

        if (data.success) {
            showSuccess('Settings sent to device via MQTT!');

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('updateSettingsModal'));
            modal.hide();

            // Reload patients
            setTimeout(() => loadPatients(), 1000);
        } else {
            showError('Failed to send settings: ' + data.error);
        }
    } catch (error) {
        console.error('Error updating settings:', error);
        showError('Error updating settings: ' + error.message);
    }
}

// Toggle remote anonymization
async function toggleRemoteAnon(uniqueKey, enabled) {
    try {
        const response = await fetch(`/api/patients/${uniqueKey}/toggle-remote-anon`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({enabled: enabled})
        });

        const data = await response.json();

        if (data.success) {
            const status = enabled ? 'enabled' : 'disabled';
            showSuccess(`Remote anonymization ${status} for patient`);

            // Reload patients to update badge
            setTimeout(() => loadPatients(), 1000);
        } else {
            showError('Failed to toggle remote anonymization: ' + data.error);

            // Revert checkbox
            const checkbox = document.querySelector(`input[onchange*="${uniqueKey}"]`);
            if (checkbox) checkbox.checked = !enabled;
        }
    } catch (error) {
        console.error('Error toggling remote anon:', error);
        showError('Error: ' + error.message);

        // Revert checkbox
        const checkbox = document.querySelector(`input[onchange*="${uniqueKey}"]`);
        if (checkbox) checkbox.checked = !enabled;
    }
}

// Copy to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showSuccess('Unique key copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy:', err);
    });
}

// Show success message
function showSuccess(message) {
    // Using Bootstrap toast or alert
    alert('✅ ' + message);
}

// Show error message
function showError(message) {
    alert('❌ ' + message);

    // Also log to console
    console.error(message);
}
</script>
{% endblock %}
