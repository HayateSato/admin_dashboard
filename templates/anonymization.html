{% extends "base.html" %}
{% block title %}Central Anonymization - Privacy Umbrella Admin{% endblock %}
{% block content %}
<!-- <h1><i class="bi bi-incognito"></i> Central Anonymization</h1> -->
<h1> Central Anonymization</h1>

<!-- Step 1: Patient Verification -->
<div class="card mb-4" id="step1-card">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0"><i class="bi bi-person-check"></i> Step 1: Patient Verification</h5>
    </div>
    <div class="card-body">
        <!-- Mode Selection -->
        <div class="mb-4">
            <label class="form-label"><strong>Do you know the patient's personal information?</strong></label>
            <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="verification-mode" id="mode-patient-info" value="patient-info" checked>
                <label class="btn btn-outline-dark" for="mode-patient-info">
                    <i class="bi bi-person-badge"></i> Yes - I know their name and details
                </label>

                <input type="radio" class="btn-check" name="verification-mode" id="mode-unique-key" value="unique-key">
                <label class="btn btn-outline-dark" for="mode-unique-key">
                    <i class="bi bi-key"></i> No - I only have their unique key
                </label>
            </div>
        </div>

        <!-- Mode A: Patient Information Form -->
        <form id="patient-verification-form" style="display: block;">
            <div class="alert alert-secondary">
                <i class="bi bi-info-circle"></i> Enter the patient's personal information to generate and verify their unique key.
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Given Name *</label>
                        <input type="text" class="form-control" id="given-name" placeholder="John" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Family Name *</label>
                        <input type="text" class="form-control" id="family-name" placeholder="Doe" required>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Date of Birth *</label>
                        <input type="date" class="form-control" id="dob" required>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label class="form-label">Gender *</label>
                        <select class="form-control" id="gender" required>
                            <option value="">Select...</option>
                            <option value="m">Male</option>
                            <option value="f">Female</option>
                            <option value="f">Other</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-1">
                    <div class="mb-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-dark w-100">
                            <i class="bi bi-search"></i> Verify
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <!-- Mode B: Unique Key Form -->
        <form id="unique-key-verification-form" style="display: none;">
            <div class="alert alert-secondary">
                <i class="bi bi-key"></i> Enter the patient's unique key directly to verify and anonymize their data.
            </div>
            <div class="row">
                <div class="col-md-11">
                    <div class="mb-3">
                        <label class="form-label">Unique Key (64 hex characters) *</label>
                        <input type="text" class="form-control font-monospace" id="unique-key-input"
                               placeholder="0000000000000000000008008000000000000000000000000000000100000000"
                               pattern="[0-9a-fA-F]{64}"
                               minlength="64"
                               maxlength="64"
                               required>
                        <small class="text-muted">Paste the 64-character hexadecimal unique key</small>
                    </div>
                </div>
                <div class="col-md-1">
                    <div class="mb-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-dark w-100">
                            <i class="bi bi-search"></i> Verify
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <!-- Verification Results -->
        <div id="verification-results" class="mt-3" style="display: none;">
            <div class="alert alert-secondary">
                <h6><i class="bi bi-info-circle"></i> Verification Result</h6>
                <div id="verification-message"></div>
            </div>

            <!-- Available Dates Table -->
            <div id="available-dates-section" style="display: none;">
                <h6>Available Data Dates:</h6>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="available-dates-table">
                        </tbody>
                    </table>
                </div>
                <button class="btn btn-dark mt-3" onclick="proceedToStep2()">
                    <i class="bi bi-arrow-right"></i> Proceed to Anonymization Settings
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Step 2: Anonymization Configuration (Initially Hidden) -->
<div class="card mb-4" id="step2-card" style="display: none;">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0"><i class="bi bi-sliders"></i> Step 2: Anonymization Configuration</h5>
    </div>
    <div class="card-body">
        <div class="alert alert-secondary">
            <strong>Patient:</strong> <span id="patient-display-name"></span><br>
            <strong>Unique Key:</strong> <code id="unique-key-display" class="small"></code>
        </div>

        <form id="anonymization-form">
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">K-Anonymity Level *</label>
                        <select class="form-control" id="k-value" required>
                            <option value="5">K = 5</option>
                            <option value="10">K = 10</option>
                            <option value="20">K = 20</option>
                            <option value="50">K = 50</option>
                        </select>
                        <small class="form-text text-muted">Higher K = More privacy, less precision</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Batch Size (seconds) *</label>
                        <input type="number" class="form-control" id="batch-size" value="5" min="1" max="60" required>
                        <small class="form-text text-muted">Time window for grouping data</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">Output Channel *</label>
                        <select class="form-control" id="output-format" onchange="toggleAPISettings()" required>
                            <option value="csv">CSV File</option>
                            <option value="influx">InfluxDB</option>
                            <option value="api">Python API</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-dark w-100">
                            <i class="bi bi-play-fill"></i> Start Anonymization
                        </button>
                    </div>
                </div>
            </div>

            <!-- API Server Settings (Conditional) -->
            <div id="api-settings" class="card mt-3" style="display: none;">
                <div class="card-header bg-secondary">
                    <h6 class="mb-0"><i class="bi bi-server"></i> Python API Server Settings</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">API Server IP *</label>
                                <input type="text" class="form-control" id="api-server-ip"
                                       placeholder="192.168.1.100" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$">
                                <small class="form-text text-muted">IPv4 address of the Python API server</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">API Server Port *</label>
                                <input type="number" class="form-control" id="api-server-port"
                                       placeholder="8000" min="1" max="65535">
                                <small class="form-text text-muted">Port number (e.g., 8000, 5000)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Optional: Date Range -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-calendar-range"></i> Optional: Date Range Filter</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start-date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" id="end-date">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div class="mt-3">
            <button class="btn btn-secondary" onclick="backToStep1()">
                <i class="bi bi-arrow-left"></i> Back to Patient Verification
            </button>
        </div>
    </div>
</div>

<!-- Recent Jobs -->
<div class="card">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0"><i class="bi bi-list-task"></i> Recent Anonymization Jobs</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Patient</th>
                        <th>K-Value</th>
                        <th>Output</th>
                        <th>Status</th>
                        <th>Created At</th>
                        <th>Progress</th>
                    </tr>
                </thead>
                <tbody id="jobs-table">
                    <tr>
                        <td colspan="7" class="text-center text-muted">No jobs yet</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Global state
let verifiedPatient = null;

// Mode switching
document.querySelectorAll('input[name="verification-mode"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const patientInfoForm = document.getElementById('patient-verification-form');
        const uniqueKeyForm = document.getElementById('unique-key-verification-form');
        const verificationResults = document.getElementById('verification-results');

        if (this.value === 'patient-info') {
            patientInfoForm.style.display = 'block';
            uniqueKeyForm.style.display = 'none';
        } else {
            patientInfoForm.style.display = 'none';
            uniqueKeyForm.style.display = 'block';
        }

        // Hide verification results when switching modes
        if (verificationResults) {
            verificationResults.style.display = 'none';
        }
        verifiedPatient = null;
    });
});

// Step 1: Patient Verification (Mode A - Patient Information)
document.getElementById('patient-verification-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const givenName = document.getElementById('given-name').value;
    const familyName = document.getElementById('family-name').value;
    const dob = document.getElementById('dob').value;
    const gender = document.getElementById('gender').value;

    try {
        const response = await fetch('/api/anonymization/verify-patient', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                given_name: givenName,
                family_name: familyName,
                dob: dob,
                gender: gender
            })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            verifiedPatient = result;

            // Show results
            document.getElementById('verification-results').style.display = 'block';

            if (result.exists === true) {
                // Patient found
                const uniqueKeyDisplay = result.unique_key ? `<p class="mb-0 small">Unique Key: <code>${result.unique_key.substring(0, 32)}...</code></p>` : '';
                const verificationMsg = document.getElementById('verification-message');
                if (verificationMsg) {
                    verificationMsg.innerHTML = `
                        <p class="mb-2"><strong>✓ Patient Found!</strong></p>
                        <p class="mb-0">Patient: <strong>${result.patient_name || 'Unknown'}</strong></p>
                        <p class="mb-0">Total Records: <strong>${result.total_records || 0}</strong> date(s)</p>
                        ${uniqueKeyDisplay}
                    `;
                }

                // Show available dates
                const datesSection = document.getElementById('available-dates-section');
                if (datesSection) {
                    datesSection.style.display = 'block';
                }

                const datesTable = document.getElementById('available-dates-table');
                if (datesTable && result.available_dates && Array.isArray(result.available_dates)) {
                    datesTable.innerHTML = '';
                    result.available_dates.forEach((dateStr, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${dateStr}</td>
                            <td><span class="badge bg-secondary">Available</span></td>
                        `;
                        datesTable.appendChild(row);
                    });
                }
            } else if (result.exists === false) {
                // Patient not found
                const uniqueKeyDisplay = result.unique_key ?
                    `<p class="mb-0 small mt-2">Generated Unique Key: <code>${result.unique_key.substring(0, 32)}...</code></p>` :
                    '';
                const verificationMsg = document.getElementById('verification-message');
                if (verificationMsg) {
                    verificationMsg.innerHTML = `
                        <p class="mb-2"><strong>✗ Patient Not Found</strong></p>
                        <p class="mb-0">${result.message || 'No data found for this patient in InfluxDB'}</p>
                        ${uniqueKeyDisplay}
                        ${result.error ? `<p class="mb-0 small text-danger mt-2">Error: ${result.error}</p>` : ''}
                    `;
                }
                const datesSection = document.getElementById('available-dates-section');
                if (datesSection) {
                    datesSection.style.display = 'none';
                }
            } else {
                // Unknown (InfluxDB unavailable)
                const uniqueKeyDisplay = result.unique_key ?
                    `<p class="mb-0 small mt-2">Generated Unique Key: <code>${result.unique_key.substring(0, 32)}...</code></p>` :
                    '';
                const proceedButton = result.unique_key ?
                    '<button class="btn btn-warning btn-sm mt-2" onclick="proceedToStep2()">Proceed Anyway</button>' :
                    '';
                const verificationMsg = document.getElementById('verification-message');
                if (verificationMsg) {
                    verificationMsg.innerHTML = `
                        <p class="mb-2"><strong>⚠ Verification Unavailable</strong></p>
                        <p class="mb-0">${result.message}</p>
                        ${uniqueKeyDisplay}
                        ${proceedButton}
                    `;
                }
                const datesSection = document.getElementById('available-dates-section');
                if (datesSection) {
                    datesSection.style.display = 'none';
                }
            }
        } else {
            alert('Error: ' + (data.error || 'Failed to verify patient'));
        }
    } catch (error) {
        console.error('Error verifying patient:', error);

        // Show error in verification section
        const verificationResults = document.getElementById('verification-results');
        if (verificationResults) {
            verificationResults.style.display = 'block';
        }

        const verificationMessage = document.getElementById('verification-message');
        if (verificationMessage) {
            verificationMessage.innerHTML = `
                <p class="mb-2"><strong>✗ Verification Error</strong></p>
                <p class="mb-0 text-danger">Failed to verify patient: ${error.message || error}</p>
                <p class="mb-0 small mt-2">Please check the console for more details.</p>
            `;
        } else {
            // Fallback to alert if element not found
            alert('Failed to verify patient: ' + error);
        }
    }
});

// Step 1: Unique Key Verification (Mode B - Direct Unique Key)
document.getElementById('unique-key-verification-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const uniqueKey = document.getElementById('unique-key-input').value.trim().toLowerCase();

    // Validate unique key format (64 hex characters)
    if (!/^[0-9a-f]{64}$/.test(uniqueKey)) {
        alert('Invalid unique key format. Must be exactly 64 hexadecimal characters.');
        return;
    }

    try {
        // For unique key mode, we skip patient verification and go straight to checking data availability
        // We'll use a simplified API call that just checks if data exists for this key
        const response = await fetch('/api/anonymization/verify-unique-key', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                unique_key: uniqueKey
            })
        });

        const data = await response.json();

        if (data.success) {
            const result = data.result;
            verifiedPatient = {
                unique_key: uniqueKey,
                patient_name: 'Unknown Patient (Key Mode)',
                exists: result.exists,
                available_dates: result.available_dates || [],
                total_records: result.total_records || 0
            };

            // Show results
            const verificationResults = document.getElementById('verification-results');
            if (verificationResults) {
                verificationResults.style.display = 'block';
            }

            if (result.exists) {
                // Data found for this unique key
                const verificationMsg = document.getElementById('verification-message');
                if (verificationMsg) {
                    verificationMsg.innerHTML = `
                        <p class="mb-2"><strong>✓ Data Found for Unique Key!</strong></p>
                        <p class="mb-0">Unique Key: <code>${uniqueKey.substring(0, 32)}...</code></p>
                        <p class="mb-0">Total Records: <strong>${result.total_records || 0}</strong> date(s)</p>
                    `;
                }

                // Show available dates
                const datesSection = document.getElementById('available-dates-section');
                if (datesSection) {
                    datesSection.style.display = 'block';
                }

                const datesTable = document.getElementById('available-dates-table');
                if (datesTable && result.available_dates && Array.isArray(result.available_dates)) {
                    datesTable.innerHTML = '';
                    result.available_dates.forEach((dateStr) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${dateStr}</td>
                            <td><span class="badge bg-secondary">Available</span></td>
                        `;
                        datesTable.appendChild(row);
                    });
                }
            } else {
                // No data found for this unique key
                const verificationMsg = document.getElementById('verification-message');
                if (verificationMsg) {
                    verificationMsg.innerHTML = `
                        <p class="mb-2"><strong>✗ No Data Found</strong></p>
                        <p class="mb-0">No data found for unique key: <code>${uniqueKey.substring(0, 32)}...</code></p>
                        <p class="mb-0 small mt-2">This key may not exist in the database or the patient has no recorded data.</p>
                    `;
                }
                const datesSection = document.getElementById('available-dates-section');
                if (datesSection) {
                    datesSection.style.display = 'none';
                }
            }
        } else {
            alert('Error: ' + (data.error || 'Failed to verify unique key'));
        }
    } catch (error) {
        console.error('Error verifying unique key:', error);

        // Show error
        const verificationResults = document.getElementById('verification-results');
        if (verificationResults) {
            verificationResults.style.display = 'block';
        }

        const verificationMessage = document.getElementById('verification-message');
        if (verificationMessage) {
            verificationMessage.innerHTML = `
                <p class="mb-2"><strong>✗ Verification Error</strong></p>
                <p class="mb-0 text-danger">Failed to verify unique key: ${error.message || error}</p>
            `;
        } else {
            alert('Failed to verify unique key: ' + error);
        }
    }
});

function proceedToStep2() {
    if (!verifiedPatient) {
        alert('Please verify patient first');
        return;
    }

    // Hide step 1, show step 2
    document.getElementById('step1-card').style.display = 'none';
    document.getElementById('step2-card').style.display = 'block';

    // Populate patient info
    document.getElementById('patient-display-name').textContent = verifiedPatient.patient_name;
    document.getElementById('unique-key-display').textContent = verifiedPatient.unique_key;

    // Scroll to step 2
    document.getElementById('step2-card').scrollIntoView({ behavior: 'smooth' });
}

function backToStep1() {
    document.getElementById('step1-card').style.display = 'block';
    document.getElementById('step2-card').style.display = 'none';
    document.getElementById('step1-card').scrollIntoView({ behavior: 'smooth' });
}

function toggleAPISettings() {
    const outputFormat = document.getElementById('output-format').value;
    const apiSettings = document.getElementById('api-settings');

    if (outputFormat === 'api') {
        apiSettings.style.display = 'block';
        document.getElementById('api-server-ip').required = true;
        document.getElementById('api-server-port').required = true;
    } else {
        apiSettings.style.display = 'none';
        document.getElementById('api-server-ip').required = false;
        document.getElementById('api-server-port').required = false;
    }
}

// Step 2: Start Anonymization
document.getElementById('anonymization-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!verifiedPatient) {
        alert('Please verify patient first');
        return;
    }

    const kValue = parseInt(document.getElementById('k-value').value);
    const batchSize = parseInt(document.getElementById('batch-size').value);
    const outputFormat = document.getElementById('output-format').value;
    const startDate = document.getElementById('start-date').value || null;
    const endDate = document.getElementById('end-date').value || null;

    const requestData = {
        unique_key: verifiedPatient.unique_key,
        patient_name: verifiedPatient.patient_name,
        k_value: kValue,
        batch_size_seconds: batchSize,
        output_format: outputFormat,
        start_time: startDate,
        end_time: endDate
    };

    // Add API server info if using API output
    if (outputFormat === 'api') {
        const apiServerIP = document.getElementById('api-server-ip').value;
        const apiServerPort = parseInt(document.getElementById('api-server-port').value);

        if (!apiServerIP || !apiServerPort) {
            alert('Please provide API server IP and port');
            return;
        }

        requestData.api_server_ip = apiServerIP;
        requestData.api_server_port = apiServerPort;
    }

    try {
        const response = await fetch('/api/anonymization/trigger', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestData)
        });

        const data = await response.json();

        if (data.success) {
            alert('Anonymization job started successfully!\\nJob ID: ' + data.job.id);

            // Reset form and go back to step 1
            document.getElementById('anonymization-form').reset();
            backToStep1();
            document.getElementById('patient-verification-form').reset();
            document.getElementById('verification-results').style.display = 'none';
            verifiedPatient = null;

            // Refresh jobs table
            loadJobs();
        } else {
            alert('Error: ' + (data.error || 'Failed to start anonymization'));
        }
    } catch (error) {
        console.error('Error starting anonymization:', error);
        alert('Failed to start anonymization: ' + error);
    }
});

// Load recent jobs
async function loadJobs() {
    try {
        const response = await fetch('/api/anonymization/jobs?limit=10');
        const jobs = await response.json();

        const tbody = document.getElementById('jobs-table');

        if (jobs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No jobs yet</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        jobs.forEach(job => {
            const row = document.createElement('tr');

            const statusBadge = {
                'pending': '<span class="badge bg-secondary">Pending</span>',
                'running': '<span class="badge bg-dark">Running</span>',
                'completed': '<span class="badge bg-dark">Completed</span>',
                'failed': '<span class="badge bg-secondary">Failed</span>',
                'cancelled': '<span class="badge bg-secondary">Cancelled</span>'
            }[job.status] || '<span class="badge bg-secondary">Unknown</span>';

            row.innerHTML = `
                <td>${job.id}</td>
                <td>${job.patient_name || job.unique_key.substring(0, 12) + '...'}</td>
                <td><span class="badge bg-secondary">K=${job.k_value}</span></td>
                <td>${job.output_format.toUpperCase()}</td>
                <td>${statusBadge}</td>
                <td>${new Date(job.created_at).toLocaleString()}</td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar" role="progressbar" style="width: ${job.progress || 0}%">
                            ${job.progress || 0}%
                        </div>
                    </div>
                </td>
            `;

            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading jobs:', error);
    }
}

// Auto-refresh jobs every 5 seconds
setInterval(loadJobs, 5000);

// Load jobs on page load
document.addEventListener('DOMContentLoaded', loadJobs);
</script>

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.alert {
    border-radius: 5px;
}
code {
    background-color: #f8f9fa;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.9em;
}
</style>
{% endblock %}
